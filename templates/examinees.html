<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Search</title>
    <!-- Add Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .navbar {
        background-color: rgba(0, 0, 0, 0.7);
        }

        .navbar-brand {
            font-size: 24px;
        }

        .navbar-toggler-icon {
            background-color: white;
        }

        .nav-item {
            margin-right: 20px;
        }

        .nav-link {
            color: white;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <a class="navbar-brand" href="/">DICT Caraga</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link" href="/">Home</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/booking">Insert Process</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/examinees">Examinees</a>
                </li>
            </ul>
            <ul class="navbar-nav ml-auto">
                {% if session.username %}
                <!-- Dropdown menu for logged-in user -->
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-toggle="dropdown"
                       aria-haspopup="true" aria-expanded="false">
                        Welcome, {{ session.username }}
                    </a>
                    <div class="dropdown-menu" aria-labelledby="userDropdown">
                        <a class="dropdown-item" href="#">Profile</a>
                        <a class="dropdown-item" href="/logout">Logout</a>
                    </div>
                </li>
                {% else %}
                <!-- Login link for guests -->
                <li class="nav-item">
                    <a class="nav-link" href="/login">Login</a>
                </li>
                {% endif %}
            </ul>
        </div>
    </nav>

    <div class="container">
        <div class="row justify-content-center mt-5">
            <div class="col-md-6">
                <h1 class="text-center">Database Search</h1>
                <form id="search-form">
                    <div class="form-group">
                        <label for="query">Search Query:</label>
                        <div class="input-group">
                            <input type="text" id="query" name="query" class="form-control" required>
                            <div class="input-group-append">
                                <button type="submit" class="btn btn-primary">Search</button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    
    <div id="results" class="container">
    </div>
    
    <form id="update-form" style="display: none;">
        <input type="hidden" name="__tableName" value="examinees"> <!-- A hidden field to store the table name -->
        <label for="label">Label</label>
        <input type="text" name="label" required>

        <label for="full_name">Full Name</label>
        <input type="text" name="full_name" required>
        
        <label for="last_name">Last Name</label>
        <input type="text" name="last_name" required>
        
        <label for="first_name">First Name</label>
        <input type="text" name="first_name" required>
        
        <label for="middle_name">Middle Name</label>
        <input type="text" name="middle_name" required>
        
        <label for="gender">Gender</label>
        <input type="text" name="gender" required>
        
        <label for="profession_or_student">Profession or Student</label>
        <input type="text" name="profession_or_student" required>
        
        <label for="course">Course</label>
        <input type="text" name="course" required>
        
        <label for="school">School</label>
        <input type="text" name="school" required>
        
        <label for="company_name">Company Name</label>
        <input type="text" name="company_name" required>
        
        <label for="position">Position</label>
        <input type="text" name="position" required>
        
        <label for="examination_date">Examination Date</label>
        <input type="text" name="examination_date" required>
        
        <label for="exam_venue">Exam Venue</label>
        <input type="text" name="exam_venue" required>
        
        <label for="status">Status</label>
        <input type="text" name="status" required>
        
        <button type="submit">Update</button>
    </form>

<!-- Place this code inside your HTML file, typically within <script> tags -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('search-form');
            const resultsDiv = document.getElementById('results');
            const updateForm = document.getElementById('update-form'); // Add reference to the update form
    
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(form);
                try {
                    const response = await fetch('/search', {
                        method: 'POST',
                        body: formData,
                    });
                    if (response.ok) {
                        const data = await response.json();
                        renderResults(data);
                    } else {
                        console.error('Response not OK');
                    }
                } catch (error) {
                    console.error('Fetch error:', error);
                }
            });
    
            function createUpdateDeleteButtons(row) {
                const updateButton = document.createElement('button');
                updateButton.textContent = 'Update';
                updateButton.addEventListener('click', () => handleUpdate(row));
    
                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Delete';
                deleteButton.addEventListener('click', () => handleDelete(row));
    
                const buttonGroup = document.createElement('div');
                buttonGroup.appendChild(updateButton);
                buttonGroup.appendChild(deleteButton);
    
                return buttonGroup;
            }
    
            function formatTableName(tableName) {
                const parts = tableName.split('_');
                return parts.map(part => part.charAt(0).toUpperCase() + part.slice(1)).join(' ');
            }
    
            function handleUpdate(row) {
                const tableName = row['__tableName'];
                const recordId = row['id'];

                // Redirect to the examinee_update_one route with table name and record ID as parameters
                window.location.href = `/examinee_update_one/${recordId}`;
            }


    
            function saveChanges(row, rowToUpdate) {
                const tableName = row['__tableName']; // Extract the table name from the data
                const recordId = row['id']; // Extract the record ID from the data
    
                const formData = new FormData();
    
                // Update the row with the edited data
                const columns = [
                    'full_name', 'last_name', 'first_name', 'middle_name', 'gender', 'profession_or_student',
                    'course', 'school', 'company_name', 'position', 'examination_date', 'exam_venue', 'status'
                ];
    
                columns.forEach((column) => {
                    const inputField = rowToUpdate.querySelector(`input[name="${column}"]`);
                    if (inputField) {
                        row[column] = inputField.value; // Update the row data
                        formData.append(column, inputField.value);
                    }
                });
    
                fetch(`/update/${tableName}/${recordId}`, {
                    method: 'POST',
                    body: formData,
                })
                .then(async (response) => {
                    if (response.ok) {
                        // Handle success
                        console.log(`Record with ID ${recordId} updated in ${tableName} successfully.`);
                        // Hide the form after saving changes
                        updateForm.style.display = 'none';
                    } else {
                        // Handle errors
                        console.error('Error during update:', response.status, response.statusText);
                    }
                })
                .catch((error) => {
                    console.error('Error:', error);
                });
            }
    
            function handleDelete(row) {
                if (confirm('Are you sure you want to delete this record?')) {
                    const tableName = row['__tableName']; // Extract the table name from the data
                    const recordId = row['id']; // Extract the record ID from the data
    
                    fetch(`/delete/${tableName}/${recordId}`, {
                        method: 'DELETE',
                    })
                    .then((response) => {
                        if (response.ok) {
                            // Handle success
                            console.log(`Record with ID ${recordId} deleted from ${tableName} successfully.`);
                            // Remove the deleted row from the table
                            const rowToDelete = document.querySelector(`tr[data-id="${recordId}"]`);
                            if (rowToDelete) {
                                rowToDelete.remove();
                            }
                        } else {
                            // Handle errors
                            console.error('Error during deletion:', response.status, response.statusText);
                        }
                    })
                    .catch((error) => {
                        console.error('Error:', error);
                    });
                }
            }
    
            function renderResults(results) {
                resultsDiv.innerHTML = '';
                for (const [tableName, tableData] of Object.entries(results)) {
                    // Check if there is data for this table
                    if (tableData.columns.length > 0 && tableData.data.length > 0) {
                        const tableHeading = document.createElement('h2');
                        tableHeading.textContent = formatTableName(tableName); // Use the formatTableName function
                        resultsDiv.appendChild(tableHeading);
    
                        const table = document.createElement('table');
                        table.classList.add('table', 'table-responsive');
                        const thead = document.createElement('thead');
                        const tbody = document.createElement('tbody');
    
                        const headers = tableData.columns; // Get column names
                        const headerRow = document.createElement('tr');
                        headers.forEach((header) => {
                            const th = document.createElement('th');
                            th.textContent = header;
                            headerRow.appendChild(th);
                        });
                        thead.appendChild(headerRow);
    
                        const rows = tableData.data; // Get data rows
                        rows.forEach((row) => {
                            const tr = document.createElement('tr');
                            headers.forEach((header) => {
                                const td = document.createElement('td');
                                td.textContent = row[header];
                                tr.appendChild(td);
                            });
    
                            // Add table name to the data for later use
                            row['__tableName'] = tableName;
    
                            // Create and append the update and delete buttons
                            const buttonGroup = createUpdateDeleteButtons(row);
                            const buttonCell = document.createElement('td');
                            buttonCell.appendChild(buttonGroup);
                            tr.appendChild(buttonCell);
    
                            tbody.appendChild(tr);
                        });
    
                        table.appendChild(thead);
                        table.appendChild(tbody);
                        resultsDiv.appendChild(table);
                    }
                }
            }
        });
    </script>
    
    

    <!-- Add Bootstrap JS (if needed) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>
</body>
</html>
